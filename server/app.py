from flask import Flask, request, jsonify
from flask_cors import CORS
import google.generativeai as genai
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)

# Configure CORS for production deployment
# –í–†–ï–ú–ï–ù–ù–û: –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ origins –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# TODO: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ALLOWED_ORIGINS –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
allowed_origins = os.getenv('ALLOWED_ORIGINS', '*')
if allowed_origins == '*':
    # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å—ë
    CORS(app, resources={
        r"/*": {
            "origins": "*",
            "methods": ["GET", "POST", "OPTIONS"],
            "allow_headers": ["Content-Type"],
            "supports_credentials": False
        }
    })
else:
    # –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ - —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    CORS(app, resources={
        r"/chat": {
            "origins": allowed_origins.split(','),
            "methods": ["POST", "OPTIONS"],
            "allow_headers": ["Content-Type"]
        }
    })

# Configure Gemini API
genai.configure(api_key=os.getenv('GOOGLE_API_KEY'))

CHAT_CONTEXT = """–¢—ã ‚Äî —á–∞—Ç-–±–æ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É AgroCredit / AgroScore.AI. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –ø—Ä–æ–µ–∫—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ–ø–∏—Å–∞–Ω–Ω—É—é –Ω–∏–∂–µ. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ª–∏—à–Ω–µ–≥–æ –∏ –Ω–µ –≤—ã—Ö–æ–¥–∏ –∑–∞ —Ä–∞–º–∫–∏ –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞. –û—Ç–≤–µ—á–∞–π —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å.

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ:

–ü—Ä–æ–µ–∫—Ç: AgroScore.AI ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –∞–≥—Ä–æ—Å–µ–∫—Ç–æ—Ä–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞.  
–¶–µ–ª—å: –ø–æ–º–æ—á—å –±–∞–Ω–∫–∞–º –∏ –ú–§–û —Ç–æ—á–Ω–µ–µ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∫—Ä–µ–¥–∏—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ñ–µ—Ä–º–µ—Ä–æ–≤, —Å–Ω–∏–∂–∞—Ç—å —Ä–∏—Å–∫–∏, —É—Å–∫–æ—Ä—è—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –∏ –¥–µ–ª–∞—Ç—å –∞–≥—Ä–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º–µ—Ä—Å–∫–∏—Ö —Ö–æ–∑—è–π—Å—Ç–≤.
- –û—Ü–µ–Ω–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª–µ–π.
- –£—á—ë—Ç –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤.
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–æ—Ä–∏–Ω–≥–æ–≤–æ–≥–æ –±–∞–ª–ª–∞ (Risk Score 0‚Äì100) —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º —Ñ–∞–∫—Ç–æ—Ä–æ–≤.
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫—Ä–µ–¥–∏—Ç—É –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ö–æ–∑—è–π—Å—Ç–≤–æ–º.
- –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Sentinel-2, Landsat).
- NDVI, NDRE, EVI –∏–Ω–¥–µ–∫—Å—ã.
- ML-–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏.
- –ê–Ω–∞–ª–∏–∑ –≤–æ–¥–Ω–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω –Ω–∞ –ø–æ–ª—è—Ö.
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑: –ø–ª–∞—Ç–µ–∂–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –¥–æ—Ö–æ–¥–æ–≤, –¥–æ–ª–≥–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—Ä–µ–¥–∏—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –û–¥–æ–±—Ä–∏—Ç—å / –û—Ç–∫–∞–∑–∞—Ç—å / –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.

–ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç:
- –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ —É —Ñ–µ—Ä–º–µ—Ä–æ–≤.
- –ë—É–º–∞–∂–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å.
- –î–æ–ª–≥–æ–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ (–¥–æ 30 –¥–Ω–µ–π).
- –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–∞.

–†–µ—à–µ–Ω–∏–µ:
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è AI-—ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤.
- –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ + –ø–æ–≥–æ–¥–∞ + –ø–æ—á–≤–∞ + —Ñ–∏–Ω–∞–Ω—Å—ã.
- –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö ‚Üí –ê–Ω–∞–ª–∏–∑ ‚Üí –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí –°–∫oring ‚Üí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è.

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- 3 –º–∏–Ω—É—Ç—ã ‚Äî –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
- ‚àí35% —Ä–∏—Å–∫ –¥–µ—Ñ–æ–ª—Ç–∞.
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∑–∞–ª–æ–≥–æ–≤—ã—Ö –∑–µ–º–µ–ª—å.
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è –±–∞–Ω–∫–∞:
- –°–Ω–∏–∂–µ–Ω–∏–µ NPL –Ω–∞ 30‚Äì40%.
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π.
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
- API-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CRM.

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è —Ñ–µ—Ä–º–µ—Ä–∞:
- –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è –æ—Ü–µ–Ω–∫–∞.
- –ë–æ–ª–µ–µ –Ω–∏–∑–∫–∞—è —Å—Ç–∞–≤–∫–∞.
- –î–æ—Å—Ç—É–ø–Ω—ã–π –æ–Ω–ª–∞–π–Ω-–ø—Ä–æ—Ü–µ—Å—Å –±–µ–∑ –±—É–º–∞–≥–∏.
- –ê–≥—Ä–æ-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫ –ø–æ–≤—ã—à–µ–Ω–∏—é —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏.

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–µ—Ä–º–µ—Ä–æ–≤:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª–µ–π (—Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ —Å–Ω–∏–º–∫–∏, —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏–π, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è).
- –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (—á–∞—Ç + –≥–æ–ª–æ—Å, —á–µ—Ä–µ–∑ –≤–µ–± –∏ Telegram).
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–æ–ª–∏–≤—É –∏ —É–¥–æ–±—Ä–µ–Ω–∏—è–º.
- –ê–≥—Ä–æ–∫–∞–ª–µ–Ω–¥–∞—Ä—å: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.
- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ö–æ–∑—è–π—Å—Ç–≤–∞: –∑–∞—Ç—Ä–∞—Ç—ã, –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å.
- –ö—Ä–µ–¥–∏—Ç–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä: –ø–æ–¥–±–æ—Ä –∫—Ä–µ–¥–∏—Ç–∞, –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ 1 –∫–ª–∏–∫.

–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:
Backend: Python, FastAPI, Go, PostgreSQL  
Frontend: Next.js 14, Tailwind  
AI Core Engine:
- CatBoost / XGBoost
- Ensemble Methods
- Computer Vision (GIS)
- Sentinel-2, Landsat
- NDVI, NDRE, EVI –∏–Ω–¥–µ–∫—Å—ã

–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:
Prototype / MVP

–î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞:
Q4 2025 ‚Äî –∏–¥–µ—è, —Å–±–æ—Ä –¥–∞—Ç–∞—Å–µ—Ç–æ–≤, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞  
Q4 2025 ‚Äî MVP –ø—Ä–æ—Ç–æ—Ç–∏–ø (ML-–º–æ–¥–µ–ª—å + –¥–µ–º–æ-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)  
Q1 2026 ‚Äî –ø–∏–ª–æ—Ç —Å –±–∞–Ω–∫–æ–º  
Q2 2026 ‚Äî —Ä–µ–ª–∏–∑ v1.0 + –ø—É–±–ª–∏—á–Ω—ã–π API + –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ  
Q3‚ÄìQ4 2026 ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ  

–ö–æ–º–∞–Ω–¥–∞:
- –®–æ—Ö–±–∞—Ö—Ç –ê—Ö–º–µ–¥–æ–≤ ‚Äî Frontend Lead  
- –ê–±–¥—É–ª–∞—Ç–∏—Ñ –ê–±–¥—É–º–∞–Ω–Ω–æ–ø–æ–≤ ‚Äî Backend Lead  
- –ñ–∞–≤–æ—Ö–∏—Ä –ì–∞–π—Ä–∞—Ç–æ–≤ ‚Äî ML Engineer  
- –ê–º–∏—Ä –ê–ª–∏–µ–≤ ‚Äî DevOps  
- –ê–∑–∏–∑ –ì–æ—Ñ—É—Ä–æ–≤ ‚Äî Project Manager  

–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–æ–≤:
1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ–Ω—è—Ç–Ω–æ –∏ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ (–µ—Å–ª–∏ –∏—Ö –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç).
2. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –ø–æ–ª—å–∑—É ‚Äî –æ–±—ä—è—Å–Ω—è–π, –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫–∏ –∏ —É—Å–∫–æ—Ä—è–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏–µ.
3. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî —É–ø–æ–º–∏–Ω–∞–π AI, ML-–º–æ–¥–µ–ª–∏, NDVI, FastAPI –∏ —Ç.–¥.
4. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –æ–ø–∏—Å–∞–Ω–∞ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äî —á–µ—Å—Ç–Ω–æ –æ—Ç–≤–µ—á–∞–π, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –ø–æ–∫–∞ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.

"""

@app.route('/chat', methods=['POST'])
def chat():
    try:
        data = request.get_json()
        message = data.get('message')
        
        if not message:
            return jsonify({'error': 'Message is required'}), 400
        
        # Create the model
        model = genai.GenerativeModel('gemini-1.5-flash')
        
        # Generate response
        full_prompt = f"{CHAT_CONTEXT}\n\nUser Question: {message}"
        response = model.generate_content(full_prompt)
        
        return jsonify({'reply': response.text})
        
    except Exception as e:
        print(f"Error: {str(e)}")
        return jsonify({'error': 'Internal server error', 'message': str(e)}), 500

if __name__ == '__main__':
    PORT = int(os.getenv('PORT', 3000))
    print(f"üöÄ Server running on http://localhost:{PORT}")
    print(f"üì° Chat endpoint: http://localhost:{PORT}/chat")
    app.run(host='0.0.0.0', port=PORT, debug=False)
